<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VouAli.pt | App Entregador</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --p: #10ac84; --d: #1e272e; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; background: #f4f4f4; overflow: hidden; }
        #login-screen { position: fixed; inset: 0; background: var(--d); color: white; z-index: 9999; display: flex; flex-direction: column; justify-content: center; padding: 30px; }
        #main-app { display: none; height: 100%; flex-direction: column; }
        #map { flex-grow: 1; }
        .header { background: var(--d); color: white; padding: 15px; text-align: center; font-weight: bold; }
        .modal { display:none; position:fixed; bottom:0; width:100%; background:white; z-index:5000; border-radius: 20px 20px 0 0; padding: 20px; box-sizing: border-box; box-shadow: 0 -5px 20px rgba(0,0,0,0.2); }
        .btn { width: 100%; padding: 15px; margin-top: 10px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .btn-go { background: var(--p); color: white; }
        .btn-done { background: #2f3542; color: white; }
        .my-pos { background: var(--p); border: 2px solid white; border-radius: 50%; }
    </style>
</head>
<body>

<div id="login-screen">
    <h1 style="color:var(--p); text-align:center">VouAli.pt</h1>
    <input type="text" id="u-id" placeholder="Seu ID de Funcion√°rio" style="padding:15px; border-radius:8px; margin-bottom:10px; border:none;">
    <button onclick="login()" style="padding:15px; background:var(--p); border:none; color:white; font-weight:bold; border-radius:8px;">ENTRAR</button>
</div>

<div id="main-app">
    <div class="header">VouAli.pt - <span id="user-display">...</span></div>
    <div id="map"></div>
</div>

<div id="modal" class="modal">
    <h3 id="m-nome">Destino</h3>
    <button class="btn btn-go" onclick="gps()">üß≠ ABRIR GOOGLE MAPS</button>
    <button class="btn btn-done" onclick="concluir()">‚úÖ CONCLU√çDO</button>
    <button class="btn" onclick="fechar()">VOLTAR</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = { databaseURL: "SUA_URL_DO_FIREBASE_AQUI" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const CID = "EMPRESA_VOUALI"; 
    let myID, map, myMarker, selectedTask;
    let markers = {};

    function login() {
        const id = document.getElementById('u-id').value.trim();
        db.ref(`WayPointPRO/${CID}/equipa/${id}`).once('value', s => {
            if(s.exists()) {
                myID = id;
                document.getElementById('user-display').innerText = s.val().nome;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'flex';
                init();
            } else { alert("ID Inv√°lido!"); }
        });
    }

    function init() {
        map = L.map('map', {zoomControl: false}).setView([0,0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        myMarker = L.marker([0,0], {icon: L.divIcon({className:'my-pos', iconSize:[12,12]})}).addTo(map);

        navigator.geolocation.watchPosition(p => {
            const lat = p.coords.latitude, lon = p.coords.longitude;
            myMarker.setLatLng([lat, lon]);
            map.flyTo([lat, lon], 15);
            db.ref(`WayPointPRO/${CID}/frota/${myID}`).set({lat, lon, ts: Date.now()});
        }, null, {enableHighAccuracy: true});

        db.ref(`WayPointPRO/${CID}/missoes`).orderByChild('atribuido_a').equalTo(myID).on('value', s => {
            const tasks = s.val() || {};
            Object.keys(markers).forEach(k => map.removeLayer(markers[k]));
            Object.keys(tasks).forEach(k => {
                const t = tasks[k];
                if(t.status !== 'concluido') {
                    markers[k] = L.marker([t.lat, t.lon]).addTo(map).on('click', () => {
                        selectedTask = {id: k, ...t};
                        document.getElementById('m-nome').innerText = t.nome;
                        document.getElementById('modal').style.display = 'block';
                    });
                }
            });
        });
    }

    function gps() { window.open(`https://www.google.com/maps/dir/?api=1&destination=${selectedTask.lat},${selectedTask.lon}`); }
    function fechar() { document.getElementById('modal').style.display = 'none'; }
    function concluir() {
        db.ref(`WayPointPRO/${CID}/missoes/${selectedTask.id}`).update({status: 'concluido'});
        fechar();
    }
</script>
</body>
</html>